# Notifier App

## Before you start

VTEX Log connects carriers and store owners to deliver better freight costs, and a simpler and smarter logistics operation. Our VTEX Log UI uses the following steps during a package's tracking process:
- **Notification:** our OMS notifies the carrier that a package is being dispatched.
- **Label:** tracking label is issued.
- **Tracking:** tracking of the package begins, and is repeated in cycles, until its final delivery.

For *carriers* to integrate with VTEX Log's Hub, our main system, it is necessary to develop apps in VTEX IO. The carrier's apps integrate with the hub, that in turn are connected to other VTEX systems, fulfilling the steps cited above.

For the integration, carriers should develop VTEX IO apps only for the `Notification` and `Tracking` steps. The `Label` app will be developed internally by the VTEX Log team, our partners. Apps should be developed by following the model files included in this repository:
- [Notification app model](https://github.com/vtex-apps/carrier-hubs-examples/tree/main/carrier-notifier-example)
- [Tracking app model](https://github.com/vtex-apps/carrier-hubs-examples/tree/main/carrier-tracking-example)

The app's developement is associated to **API routes** that should also be developed by the carrier for the app to function fully. Check out our [API Reference](https://developers.vtex.com/vtex-developer-docs/reference/vtex-log-notification-app#vtex-log-notify-carrier-with-app) for more details about all API calls.

## Notifier App Model

This is a reference app that implements the builder for carrier notifying apps. It also exports the API that integrates with the VTEX notification hub.

Requirements for an IO app that notifies carriers:
- Use the *Node* or *Dotnet* and *vtex.carrier-notifier* builders.
- Export the API that is called by the *vtex.carrier-notifier* app.

Follow the instructions below, to model your notifier app according to this example.

### vtex.carrier-notifier builder
Along with the Node or Dotnet builder, the use of the vtex.carrier-notifier builder is what makes the app as a notifier type, and thus be detected by our hub. The steps to use the builder:

1. Add builder `vtex.carrier-notifier: 0.x` to the list of builders, in the file `manifest.json`. Ex:
```
"builders": {
    "node": "6.x",
    "vtex.carrier-notifier": "0.x"
}
```
2. Create the `vtex.carrier-notifier` folder at the *root* of the project.
 Within it, create the `configuration.json` file. 
 This file must contain the name of the notified carrier, which will be displayed to the customer or user.  File format:
```
{
  "notificationOptions": [
    {
      "carrierName": string
    }
  ]
}
```

## API routes

### Notify Carrier: /notify

> Check out the [API Reference](https://developers.vtex.com/vtex-developer-docs/reference/vtex-log-notification-app#vtex-log-notify-carrier-with-app) for full details.

This endpoint notifies the carrier about a dispatch order by calling the `vtex.carrier-notifier` app. When the call is made, the following data is sent: 
- Dispatched packages information 
- Fiscal information about the carrier notified 
- Carrier's contact email. 
The call's response includes all tracking data and each package's ID generated by the notification made to the carrier.

**1. Input sent by the hub**: ([typing details](https://github.com/vtex-apps/carrier-hubs-examples/blob/main/carrier-notifier-example/node/typings/typings.d.ts#L187))
```
{
	"dispatchOrder": DispatchOrder,
	"email": string
}
```
**2. Expected output**: a map whose keys are the `packageIds`, and the value is an object containing the tracking information and the package's `notificationId`.
```
{
	<packageId> : {
		"tracking": {
			"number": string,
			"url": string
		},
		"notification": {
			"id": string
		}
	}
}
```
**3. Example route definition in the `service.json` file of a Node or Dotnet app**:
```
"notify": {
      "path": "/notify",
      "public": false,
      "access": "authorized",
      "policies": [
        {
          "effect": "allow",
          "actions": [
            "post"
          ],
          "principals": [
            "vrn:apps:*:{{account}}:{{workspace}}:app/vtex.carrier-notifier@*"
          ]
        }
      ]
    }
```
